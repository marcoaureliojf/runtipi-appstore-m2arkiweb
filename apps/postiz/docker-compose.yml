version: "3.9"
services:
  postiz: # Should be exact same name as "id" field in config.json
    container_name: postiz # Should be exact same name as "id" field in config.json
    image: ghcr.io/gitroomhq/postiz-app # Try to avoid "latest" tag. As it may break configs in the future.
    restart: unless-stopped # Do not change this
    environment:
      - TZ=${TZ} # Can use any env variable. See "environment variables" section in the docs
      # You must change these. Replace `postiz.your-server.com` with your DNS name or "localhost:port" - what your web browser sees.
      - MAIN_URL=postiz.${LOCAL_DOMAIN}
      - FRONTEND_URL=postiz.${LOCAL_DOMAIN}
      - NEXT_PUBLIC_BACKEND_URL=postiz.${LOCAL_DOMAIN}/api
      - JWT_SECRET=pL^$#6MXDM%x5hXPzr2%XD6Md
 
      # These defaults are probably fine, but if you change your user/password, update it in the
      # postiz-postgres or postiz-redis services below.
      - DATABASE_URL=postgresql://postiz-user:postiz-password@postiz-postgres:5432/postiz-db-local
      - REDIS_URL=redis://postiz-redis:6379
      - BACKEND_INTERNAL_URL=http://localhost:3000
      - IS_GENERAL=true # Required for self-hosting.
      # The container images are pre-configured to use /uploads for file storage.
      # You probably should not change this unless you have a really good reason!
      - STORAGE_PROVIDER=local
      - UPLOAD_DIRECTORY=/uploads
      - NEXT_PUBLIC_UPLOAD_DIRECTORY=/uploads
    volumes:
      - ${APP_DATA_DIR}/data/config:/config # Always start the path with ${APP_DATA_DIR}/data/. This will put all data inside app-data/postiz/data
      - ${APP_DATA_DIR}/data/uploads:/uploads
    ports:
      - ${APP_PORT}:5000
    networks:
      - postiz-network # That should not be changed
    labels: # Use your editors search and replace feature to replace all instances of "postiz" with your app name in the traefik labels
      # Main
      traefik.enable: true
      traefik.http.middlewares.postiz-web-redirect.redirectscheme.scheme: https
      traefik.http.services.postiz.loadbalancer.server.port: 5000 # Should be the same as the app internal port so for this example 9443
      # Web
      traefik.http.routers.postiz-insecure.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.postiz-insecure.entrypoints: web
      traefik.http.routers.postiz-insecure.service: postiz
      traefik.http.routers.postiz-insecure.middlewares: postiz-web-redirect
      # Websecure
      traefik.http.routers.postiz.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.postiz.entrypoints: websecure
      traefik.http.routers.postiz.service: postiz
      traefik.http.routers.postiz.tls.certresolver: myresolver
      # Local domain
      traefik.http.routers.postiz-local-insecure.rule: Host(`postiz.${LOCAL_DOMAIN}`)
      traefik.http.routers.postiz-local-insecure.entrypoints: web
      traefik.http.routers.postiz-local-insecure.service: postiz
      traefik.http.routers.postiz-local-insecure.middlewares: postiz-web-redirect
      # Local domain secure
      traefik.http.routers.postiz-local.rule: Host(`postiz.${LOCAL_DOMAIN}`)
      traefik.http.routers.postiz-local.entrypoints: websecure
      traefik.http.routers.postiz-local.service: postiz
      traefik.http.routers.postiz-local.tls: true
  postiz-postgres:
    image: postgres:17-alpine
    container_name: postiz-postgres
    restart: always
    environment:
      POSTGRES_PASSWORD: postiz-password
      POSTGRES_USER: postiz-user
      POSTGRES_DB: postiz-db-local
    volumes:
      - postgres-volume:/var/lib/postgresql/data
    networks:
      - postiz-network
    healthcheck:
      test: pg_isready -U postiz-user -d postiz-db-local
      interval: 10s
      timeout: 3s
      retries: 3
  postiz-redis:
    image: redis:7.2
    container_name: postiz-redis
    restart: always
    healthcheck:
      test: redis-cli ping
      interval: 10s
      timeout: 3s
      retries: 3
    volumes:
      - postiz-redis-data:/data
    networks:
      - postiz-network
volumes:
  postgres-volume:
    external: false
 
  postiz-redis-data:
    external: false
 
  postiz-config:
    external: false
 
  postiz-uploads:
    external: false
 
networks:
  postiz-network:
    external: false      
  